exception = TypeError("a bytes-like object is required, not 'str'")

    @staticmethod
    def _raise_session_broken_exception(exception):
        logger.debug('%s: %s\nBacktrace: \n%s',
                     exception.__class__.__name__,
                     exception,
                     ''.join(traceback.format_list(traceback.extract_tb(
                         sys.exc_info()[2]))))
>       raise RunnerTerminalSessionBroken(exception)
E       crl.interactivesessions.runnerexceptions.RunnerTerminalSessionBroken: a bytes-like object is required, not 'str'

../lib/python3.7/site-packages/crl/interactivesessions/runnerterminal.py:242: RunnerTerminalSessionBroken
---------------------------------------------------- Captured stderr call -----------------------------------------------------
Created new <tests.shells.mock_interactivesession.MockPythonInteractiveSession object at 0x7f0336f93e10>
MainProcess 2019-06-11 14:17:03,057.057 DEBUG Created new <tests.shells.mock_interactivesession.MockPythonInteractiveSession object at 0x7f0336f93e10>
PythonShellEmulator running cmd: import pickle, imp, base64, os, timeout=-1
MainProcess 2019-06-11 14:17:03,063.063 DEBUG PythonShellEmulator running cmd: import pickle, imp, base64, os, timeout=-1
PythonShellEmulator response: 
MainProcess 2019-06-11 14:17:03,063.063 DEBUG PythonShellEmulator response: 
PythonShellEmulator running cmd: _handlercode = compile(pickle.loads(base64.b64decode(b'gANYAhoAAGltcG9ydCBvcwppbXBvcnQgc3lzCmltcG9ydCBwaWNrbGUKaW1wb3J0IGJhc2U2NAppbXBvcnQgdHJhY2ViYWNrCmltcG9ydCB0aHJlYWRpbmcKaW1wb3J0IGZjbnRsCmZyb20gaW8gaW1wb3J0IEJ5dGVzSU8KZnJvbSBjb250ZXh0bGliIGltcG9ydCBjb250ZXh0bWFuYWdlcgpmcm9tIGZ1bmN0b29scyBpbXBvcnQgd3JhcHMKCgpfX2NvcHlyaWdodF9fID0gJ0NvcHlyaWdodCAoQykgMjAxOSwgTm9raWEnCgpUT0tFTiA9ICcrN188c2Y4MFVCdGQldW16JwoKCmRlZiBnZXRfcHl0aG9uX2ZpbGVfcGF0aCgpOgogICAgcmV0dXJuIG9zLnBhdGguYWJzcGF0aChfX2ZpbGVfXwogICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBfX2ZpbGVfXy5lbmRzd2l0aCgneScpIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgX19maWxlX19bOi0xXSkKCgpjbGFzcyBfQ29udGFpbmVyKG9iamVjdCk6CiAgICBwYXNzCgoKX1BST1hZX0NPTlRBSU5FUiA9IF9Db250YWluZXIoKQoKCmRlZiBleGVjX2luX21vZHVsZShjb2RlLCBtb2R1bGUpOgogICAgZXhlYyhjb2RlLCBtb2R1bGUuX19kaWN0X18pCgoKY2xhc3MgRmlsZUhhbmRsZShvYmplY3QpOgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBoYW5kbGUpOgogICAgICAgIHNlbGYuaGFuZGxlID0gaGFuZGxlCiAgICAgICAgc2VsZi5pbmZpbGUgPSBzeXMuc3RkaW4KICAgICAgICBzZWxmLm91dGZpbGUgPSBOb25lCgogICAgZGVmIHNldF9pb19vdXRmaWxlKHNlbGYsIG91dGZpbGUpOgogICAgICAgIHNlbGYub3V0ZmlsZSA9IG91dGZpbGUKCiAgICBkZWYgd3JpdGUoc2VsZiwgc2l6ZSk6CiAgICAgICAgc2VsZi5fd3JpdGVfc3Rkb3V0X3dpdGhfZmx1c2goJ3JlYWRpbmcgc3RhcnQnKQogICAgICAgIHdpdGggc2VsZi5fYmxvY2tpbmdfY29udGV4dCgpOgogICAgICAgICAgICBzZWxmLmhhbmRsZS53cml0ZShiYXNlNjQuYjY0ZGVjb2RlKHNlbGYuaW5maWxlLnJlYWQoc2l6ZSkpKQogICAgICAgIHNlbGYuX3dyaXRlX3N0ZG91dF93aXRoX2ZsdXNoKCdyZWFkaW5nIHN0b3AnKQoKICAgIEBjb250ZXh0bWFuYWdlcgogICAgZGVmIF9ibG9ja2luZ19jb250ZXh0KHNlbGYpOgogICAgICAgIGluZmQgPSBzZWxmLmluZmlsZS5maWxlbm8oKQogICAgICAgIGZsID0gZmNudGwuZmNudGwoaW5mZCwgZmNudGwuRl9HRVRGTCkKICAgICAgICBmY250bC5mY250bChpbmZkLCBmY250bC5GX1NFVEZMLCBmbCAmIH5vcy5PX05PTkJMT0NLKQogICAgICAgIHRyeToKICAgICAgICAgICAgeWllbGQgTm9uZQogICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgIGZjbnRsLmZjbnRsKGluZmQsIGZjbnRsLkZfU0VURkwsIGZsKQoKICAgIGRlZiBfd3JpdGVfc3Rkb3V0X3dpdGhfZmx1c2goc2VsZiwgYnVmKToKICAgICAgICBzZWxmLm91dGZpbGUud3JpdGUoYnVmKQogICAgICAgIHNlbGYub3V0ZmlsZS5mbHVzaCgpCgogICAgZGVmIHJlYWQoc2VsZiwgc2l6ZSk6CiAgICAgICAgYnVmID0gc2VsZi5oYW5kbGUucmVhZChzaXplKQogICAgICAgIHNlbGYuX3dyaXRlX3N0ZG91dF93aXRoX2ZsdXNoKGIne3Rva2VufXtsZW5idWY6MDExZH17YnVmfScuZm9ybWF0KAogICAgICAgICAgICB0b2tlbj1UT0tFTiwKICAgICAgICAgICAgbGVuYnVmPWxlbihidWYpLAogICAgICAgICAgICBidWY9YnVmKSkKCgpjbGFzcyBfUmVzcG9uc2Uob2JqZWN0KToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBmdW5jdGlvbiwgcnVubmVyaGFuZGxlciwgKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICBzZWxmLnJlc3BvbnNlID0gTm9uZQogICAgICAgIHNlbGYuZnVuY3Rpb24gPSBmdW5jdGlvbgogICAgICAgIHNlbGYucnVubmVyaGFuZGxlciA9IHJ1bm5lcmhhbmRsZXIKICAgICAgICBzZWxmLmFyZ3MgPSBhcmdzCiAgICAgICAgc2VsZi5rd2FyZ3MgPSBrd2FyZ3MuY29weSgpCiAgICAgICAgc2VsZi50aW1lb3V0ID0gTm9uZQogICAgICAgIHNlbGYuX2hhbmRsZV90aW1lb3V0X2t3YXJnKCkKICAgICAgICBzZWxmLnRocmVhZCA9IE5vbmUKICAgICAgICBzZWxmLnJlc3BvbnNlX2lkID0gaWQoc2VsZikKCiAgICBkZWYgX2hhbmRsZV90aW1lb3V0X2t3YXJnKHNlbGYpOgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi50aW1lb3V0ID0gc2VsZi5rd2FyZ3NbJ3RpbWVvdXQnXQogICAgICAgICAgICBkZWwgc2VsZi5rd2FyZ3NbJ3RpbWVvdXQnXQogICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgcGFzcwoKICAgIGRlZiBzZXRfcmVzcG9uc2Uoc2VsZiwgcmVzcG9uc2UpOgogICAgICAgIHNlbGYucmVzcG9uc2UgPSByZXNwb25zZQoKICAgIGRlZiBydW4oc2VsZik6CiAgICAgICAgd2l0aCBzZWxmLnJ1bm5lcmhhbmRsZXIuY29udGV4dG1ncihzZWxmKToKICAgICAgICAgICAgc2VsZi5zZXRfcmVzcG9uc2UoCiAgICAgICAgICAgICAgICBzZWxmLmZ1bmN0aW9uKHNlbGYucnVubmVyaGFuZGxlciwgKnNlbGYuYXJncywgKipzZWxmLmt3YXJncykpCgogICAgZGVmIHJ1bl9pbl90aHJlYWQoc2VsZik6CiAgICAgICAgc2VsZi50aHJlYWQgPSB0aHJlYWRpbmcuVGhyZWFkKHRhcmdldD1zZWxmLnJ1bikKICAgICAgICBzZWxmLnRocmVhZC5zdGFydCgpCiAgICAgICAgcmV0dXJuIHNlbGYuZ2V0X3Jlc3BvbnNlX3dpdGhfdGltZW91dChzZWxmLnRpbWVvdXQpCgogICAgZGVmIGdldF9yZXNwb25zZV93aXRoX3RpbWVvdXQoc2VsZiwgdGltZW91dCk6CiAgICAgICAgaWYgdGltZW91dCA+PSAwIG9yIHRpbWVvdXQgaXMgTm9uZToKICAgICAgICAgICAgc2VsZi50aHJlYWQuam9pbih0aW1lb3V0KQogICAgICAgIHJldHVybiBzZWxmLl9nZXRfcmVzcG9uc2VfZnJvbV90aHJlYWQodGltZW91dCkKCiAgICBkZWYgX2dldF9yZXNwb25zZV9mcm9tX3RocmVhZChzZWxmLCB0aW1lb3V0KToKICAgICAgICBpZiAoKHRpbWVvdXQgaXMgbm90IE5vbmUgYW5kIHRpbWVvdXQgPCAwKSBvcgogICAgICAgICAgICAgICAgc2VsZi50aHJlYWQuaXNBbGl2ZSgpKToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX3N0b3JlX2FuZF9yZXR1cm5fcmVzcG9uc2UoKQogICAgICAgIHNlbGYucnVubmVyaGFuZGxlci5yZW1vdmVfcmVzcG9uc2Uoc2VsZi5yZXNwb25zZV9pZCkKICAgICAgICByZXR1cm4gc2VsZi5fc2VyaWFsaXplKCpzZWxmLnJlc3BvbnNlKQoKICAgIGRlZiBfc3RvcmVfYW5kX3JldHVybl9yZXNwb25zZShzZWxmKToKICAgICAgICBzZWxmLnJ1bm5lcmhhbmRsZXIuYWRkX3Jlc3BvbnNlKHNlbGYucmVzcG9uc2VfaWQsIHNlbGYpCiAgICAgICAgcmV0dXJuIHNlbGYuX3NlcmlhbGl6ZSgndGltZW91dCcsIHNlbGYucmVzcG9uc2VfaWQpCgogICAgZGVmIF9zZXJpYWxpemUoc2VsZiwgc3RlZXJpbmdzdHJpbmcsIG9iaik6CiAgICAgICAgcmV0dXJuIGJhc2U2NC5iNjRlbmNvZGUoc2VsZi5ydW5uZXJoYW5kbGVyLnBpY2tsZXIuZHVtcHMoCiAgICAgICAgICAgIChzdGVlcmluZ3N0cmluZywgc2VsZi5ydW5uZXJoYW5kbGVyLnBpY2tsZXIuZHVtcHMob2JqKSkpKQoKCmRlZiByZXNwb25zZXRocmVhZChmdW5jdGlvbiwgKmFyZ3MsICoqa3dhcmdzKToKICAgICMgcHlsaW50OiBkaXNhYmxlPXVudXNlZC1hcmd1bWVudAogICAgQHdyYXBzKGZ1bmN0aW9uKQogICAgZGVmIGlubmVyX2Z1bmN0aW9uKHJ1bm5lcmhhbmRsZXIsICphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgcmV0dXJuIF9SZXNwb25zZSgKICAgICAgICAgICAgZnVuY3Rpb24sIHJ1bm5lcmhhbmRsZXIsICphcmdzLCAqKmt3YXJncykucnVuX2luX3RocmVhZCgpCgogICAgcmV0dXJuIGlubmVyX2Z1bmN0aW9uCgoKY2xhc3MgX1J1bm5lckhhbmRsZXIob2JqZWN0KToKCiAgICBkZWYgX19pbml0X18oc2VsZik6CiAgICAgICAgc2VsZi5jb250ZXh0bWdyID0gTm9uZQogICAgICAgIHNlbGYucGlja2xlciA9IE5vbmUKICAgICAgICBzZWxmLl9oYW5kbGVkX3R5cGVzID0gTm9uZQogICAgICAgIHNlbGYuX3Jlc3BvbnNlcyA9IGRpY3QoKQoKICAgIGRlZiBpbml0aWFsaXplKHNlbGYsCiAgICAgICAgICAgICAgICAgICBjb250ZXh0bWdyPU5vbmUsCiAgICAgICAgICAgICAgICAgICBwaWNrbGVyPXBpY2tsZSwKICAgICAgICAgICAgICAgICAgIGhhbmRsZWRfdHlwZXM9Tm9uZSk6CiAgICAgICAgc2VsZi5jb250ZXh0bWdyID0gY29udGV4dG1nciBvciBzZWxmLnBpY2tsZV9lcnJvcnMKICAgICAgICBzZWxmLnBpY2tsZXIgPSBwaWNrbGVyCiAgICAgICAgc2VsZi5faGFuZGxlZF90eXBlcyA9IFtdIGlmIGhhbmRsZWRfdHlwZXMgaXMgTm9uZSBlbHNlIGhhbmRsZWRfdHlwZXMKCiAgICBkZWYgYWRkX3Jlc3BvbnNlKHNlbGYsIHJlc3BvbnNlX2lkLCByZXNwb25zZSk6CiAgICAgICAgc2VsZi5fcmVzcG9uc2VzW3Jlc3BvbnNlX2lkXSA9IHJlc3BvbnNlCgogICAgZGVmIF9nZXRfcmVzcG9uc2Uoc2VsZiwgcmVzcG9uc2VfaWQpOgogICAgICAgIHJldHVybiBzZWxmLl9yZXNwb25zZXNbcmVzcG9uc2VfaWRdCgogICAgZGVmIHJlbW92ZV9yZXNwb25zZShzZWxmLCByZXNwb25zZV9pZCk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBkZWwgc2VsZi5fcmVzcG9uc2VzW3Jlc3BvbnNlX2lkXQogICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgcGFzcwoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBfZGVzZXJpYWxpemUoY29udGVudCwgdW5waWNrbGVyPXBpY2tsZS5VbnBpY2tsZXIpOgogICAgICAgIGlmIChzeXMudmVyc2lvbl9pbmZvWzBdID09IDMpOgogICAgICAgICAgICBjb250ZW50ID0gY29udGVudC5kZWNvZGUoJ3V0Zi04JykKICAgICAgICBvdXRwdXRzdHJlYW0gPSBCeXRlc0lPKGJhc2U2NC5iNjRkZWNvZGUoY29udGVudCkpCiAgICAgICAgcmV0dXJuIHVucGlja2xlcihvdXRwdXRzdHJlYW0pLmxvYWQoKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBfZXh0cmFjdF90YigpOgogICAgICAgIHJldHVybiB0cmFjZWJhY2suZm9ybWF0X2xpc3QodHJhY2ViYWNrLmV4dHJhY3RfdGIoCiAgICAgICAgICAgIHN5cy5leGNfaW5mbygpWzJdKVszOl0pCgogICAgQGNvbnRleHRtYW5hZ2VyCiAgICBkZWYgcGlja2xlX2Vycm9ycyhzZWxmLCByZXNwb25zZSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB5aWVsZCBOb25lCgogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZTogICMgcHlsaW50OiBkaXNhYmxlPWJyb2FkLWV4Y2VwdAogICAgICAgICAgICBlLnRyYWNlID0gc2VsZi5fZXh0cmFjdF90YigpCiAgICAgICAgICAgIHJlc3BvbnNlLnNldF9yZXNwb25zZSgoJ2V4Y2VwdGlvbicsIGUpKQoKICAgIEByZXNwb25zZXRocmVhZAogICAgZGVmIHJ1bihzZWxmLCBjb2RlLCBsb2NhbHNfKToKICAgICAgICByZXR1cm4gKCdydW4nLCBzZWxmLl9nZXRfb2JqZWN0KGNvZGUsIGxvY2Fsc18pKQoKICAgIEByZXNwb25zZXRocmVhZAogICAgZGVmIGFzc2lnbl9hbmRfcnVuKHNlbGYsIGhhbmRsZSwgY29kZSwgbG9jYWxzXyk6CiAgICAgICAgc2VsZi5fZ2V0X29iamVjdCgne2hhbmRsZX0gPSB7Y29kZX0nLmZvcm1hdCgKICAgICAgICAgICAgaGFuZGxlPWhhbmRsZSwgY29kZT1jb2RlKSwgbG9jYWxzXykKICAgICAgICByZXR1cm4gc2VsZi5fZ2V0X2hhbmRsZWQoaGFuZGxlLCBsb2NhbHNfKQoKICAgIEByZXNwb25zZXRocmVhZAogICAgZGVmIHJ1bl9hbmRfcmV0dXJuX2hhbmRsZWQoc2VsZiwgY29kZSwgbG9jYWxzXyk6CiAgICAgICAgcmV0dXJuIHNlbGYuX2dldF9oYW5kbGVkKGNvZGUsIGxvY2Fsc18pCgogICAgZGVmIGdldF9yZXNwb25zZShzZWxmLCByZXNwb25zZV9pZCwgdGltZW91dCk6CiAgICAgICAgcmV0dXJuIHNlbGYuX2dldF9yZXNwb25zZSgKICAgICAgICAgICAgcmVzcG9uc2VfaWQpLmdldF9yZXNwb25zZV93aXRoX3RpbWVvdXQodGltZW91dCkKCiAgICBkZWYgX2dldF9oYW5kbGVkKHNlbGYsIGNvZGUsIGxvY2Fsc18pOgogICAgICAgIG9iaiA9IHNlbGYuX2dldF9vYmplY3QoY29kZSwgbG9jYWxzXykKICAgICAgICBpc19oYW5kbGVkID0gc2VsZi5faXNfaW5faGFuZGxlZF90eXBlcyhvYmopCiAgICAgICAgc3RlZXJpbmdzdHJpbmcgPSAnaGFuZGxlZCcgaWYgaXNfaGFuZGxlZCBlbHNlICdub3RoYW5kbGVkJwogICAgICAgIHJldHVybiAoc3RlZXJpbmdzdHJpbmcsIG9iaiBpZiBpc19oYW5kbGVkIGVsc2UgTm9uZSkKCiAgICBkZWYgX2lzX2luX2hhbmRsZWRfdHlwZXMoc2VsZiwgb2JqKToKICAgICAgICBmb3IgdCBpbiBzZWxmLl9oYW5kbGVkX3R5cGVzOgogICAgICAgICAgICBpZiB0IGlzIE5vbmU6CiAgICAgICAgICAgICAgICBpZiBvYmogaXMgTm9uZToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2Uob2JqLCB0KToKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIF9nZXRfb2JqZWN0KGNvZGUsIGxvY2Fsc18pOgogICAgICAgIHRyeToKICAgICAgICAgICAgY29kZV9vYmogPSBjb21waWxlKGNvZGUsICcnLCAnZXZhbCcpCiAgICAgICAgZXhjZXB0IFN5bnRheEVycm9yOgogICAgICAgICAgICBjb2RlX29iaiA9IGNvbXBpbGUoY29kZSwgJycsICdzaW5nbGUnKQogICAgICAgIHJldHVybiBldmFsKGNvZGVfb2JqLCBsb2NhbHNfKQoKCl9SVU5ORVJIQU5ETEVSID0gX1J1bm5lckhhbmRsZXIoKQpxAC4=')), 'RunnerHandler', 'exec'), timeout=-1
MainProcess 2019-06-11 14:17:03,064.064 DEBUG PythonShellEmulator running cmd: _handlercode = compile(pickle.loads(base64.b64decode(b'gANYAhoAAGltcG9ydCBvcwppbXBvcnQgc3lzCmltcG9ydCBwaWNrbGUKaW1wb3J0IGJhc2U2NAppbXBvcnQgdHJhY2ViYWNrCmltcG9ydCB0aHJlYWRpbmcKaW1wb3J0IGZjbnRsCmZyb20gaW8gaW1wb3J0IEJ5dGVzSU8KZnJvbSBjb250ZXh0bGliIGltcG9ydCBjb250ZXh0bWFuYWdlcgpmcm9tIGZ1bmN0b29scyBpbXBvcnQgd3JhcHMKCgpfX2NvcHlyaWdodF9fID0gJ0NvcHlyaWdodCAoQykgMjAxOSwgTm9raWEnCgpUT0tFTiA9ICcrN188c2Y4MFVCdGQldW16JwoKCmRlZiBnZXRfcHl0aG9uX2ZpbGVfcGF0aCgpOgogICAgcmV0dXJuIG9zLnBhdGguYWJzcGF0aChfX2ZpbGVfXwogICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBfX2ZpbGVfXy5lbmRzd2l0aCgneScpIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgX19maWxlX19bOi0xXSkKCgpjbGFzcyBfQ29udGFpbmVyKG9iamVjdCk6CiAgICBwYXNzCgoKX1BST1hZX0NPTlRBSU5FUiA9IF9Db250YWluZXIoKQoKCmRlZiBleGVjX2luX21vZHVsZShjb2RlLCBtb2R1bGUpOgogICAgZXhlYyhjb2RlLCBtb2R1bGUuX19kaWN0X18pCgoKY2xhc3MgRmlsZUhhbmRsZShvYmplY3QpOgoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBoYW5kbGUpOgogICAgICAgIHNlbGYuaGFuZGxlID0gaGFuZGxlCiAgICAgICAgc2VsZi5pbmZpbGUgPSBzeXMuc3RkaW4KICAgICAgICBzZWxmLm91dGZpbGUgPSBOb25lCgogICAgZGVmIHNldF9pb19vdXRmaWxlKHNlbGYsIG91dGZpbGUpOgogICAgICAgIHNlbGYub3V0ZmlsZSA9IG91dGZpbGUKCiAgICBkZWYgd3JpdGUoc2VsZiwgc2l6ZSk6CiAgICAgICAgc2VsZi5fd3JpdGVfc3Rkb3V0X3dpdGhfZmx1c2goJ3JlYWRpbmcgc3RhcnQnKQogICAgICAgIHdpdGggc2VsZi5fYmxvY2tpbmdfY29udGV4dCgpOgogICAgICAgICAgICBzZWxmLmhhbmRsZS53cml0ZShiYXNlNjQuYjY0ZGVjb2RlKHNlbGYuaW5maWxlLnJlYWQoc2l6ZSkpKQogICAgICAgIHNlbGYuX3dyaXRlX3N0ZG91dF93aXRoX2ZsdXNoKCdyZWFkaW5nIHN0b3AnKQoKICAgIEBjb250ZXh0bWFuYWdlcgogICAgZGVmIF9ibG9ja2luZ19jb250ZXh0KHNlbGYpOgogICAgICAgIGluZmQgPSBzZWxmLmluZmlsZS5maWxlbm8oKQogICAgICAgIGZsID0gZmNudGwuZmNudGwoaW5mZCwgZmNudGwuRl9HRVRGTCkKICAgICAgICBmY250bC5mY250bChpbmZkLCBmY250bC5GX1NFVEZMLCBmbCAmIH5vcy5PX05PTkJMT0NLKQogICAgICAgIHRyeToKICAgICAgICAgICAgeWllbGQgTm9uZQogICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgIGZjbnRsLmZjbnRsKGluZmQsIGZjbnRsLkZfU0VURkwsIGZsKQoKICAgIGRlZiBfd3JpdGVfc3Rkb3V0X3dpdGhfZmx1c2goc2VsZiwgYnVmKToKICAgICAgICBzZWxmLm91dGZpbGUud3JpdGUoYnVmKQogICAgICAgIHNlbGYub3V0ZmlsZS5mbHVzaCgpCgogICAgZGVmIHJlYWQoc2VsZiwgc2l6ZSk6CiAgICAgICAgYnVmID0gc2VsZi5oYW5kbGUucmVhZChzaXplKQogICAgICAgIHNlbGYuX3dyaXRlX3N0ZG91dF93aXRoX2ZsdXNoKGIne3Rva2VufXtsZW5idWY6MDExZH17YnVmfScuZm9ybWF0KAogICAgICAgICAgICB0b2tlbj1UT0tFTiwKICAgICAgICAgICAgbGVuYnVmPWxlbihidWYpLAogICAgICAgICAgICBidWY9YnVmKSkKCgpjbGFzcyBfUmVzcG9uc2Uob2JqZWN0KToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBmdW5jdGlvbiwgcnVubmVyaGFuZGxlciwgKmFyZ3MsICoqa3dhcmdzKToKICAgICAgICBzZWxmLnJlc3BvbnNlID0gTm9uZQogICAgICAgIHNlbGYuZnVuY3Rpb24gPSBmdW5jdGlvbgogICAgICAgIHNlbGYucnVubmVyaGFuZGxlciA9IHJ1bm5lcmhhbmRsZXIKICAgICAgICBzZWxmLmFyZ3MgPSBhcmdzCiAgICAgICAgc2VsZi5rd2FyZ3MgPSBrd2FyZ3MuY29weSgpCiAgICAgICAgc2VsZi50aW1lb3V0ID0gTm9uZQogICAgICAgIHNlbGYuX2hhbmRsZV90aW1lb3V0X2t3YXJnKCkKICAgICAgICBzZWxmLnRocmVhZCA9IE5vbmUKICAgICAgICBzZWxmLnJlc3BvbnNlX2lkID0gaWQoc2VsZikKCiAgICBkZWYgX2hhbmRsZV90aW1lb3V0X2t3YXJnKHNlbGYpOgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi50aW1lb3V0ID0gc2VsZi5rd2FyZ3NbJ3RpbWVvdXQnXQogICAgICAgICAgICBkZWwgc2VsZi5rd2FyZ3NbJ3RpbWVvdXQnXQogICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgcGFzcwoKICAgIGRlZiBzZXRfcmVzcG9uc2Uoc2VsZiwgcmVzcG9uc2UpOgogICAgICAgIHNlbGYucmVzcG9uc2UgPSByZXNwb25zZQoKICAgIGRlZiBydW4oc2VsZik6CiAgICAgICAgd2l0aCBzZWxmLnJ1bm5lcmhhbmRsZXIuY29udGV4dG1ncihzZWxmKToKICAgICAgICAgICAgc2VsZi5zZXRfcmVzcG9uc2UoCiAgICAgICAgICAgICAgICBzZWxmLmZ1bmN0aW9uKHNlbGYucnVubmVyaGFuZGxlciwgKnNlbGYuYXJncywgKipzZWxmLmt3YXJncykpCgogICAgZGVmIHJ1bl9pbl90aHJlYWQoc2VsZik6CiAgICAgICAgc2VsZi50aHJlYWQgPSB0aHJlYWRpbmcuVGhyZWFkKHRhcmdldD1zZWxmLnJ1bikKICAgICAgICBzZWxmLnRocmVhZC5zdGFydCgpCiAgICAgICAgcmV0dXJuIHNlbGYuZ2V0X3Jlc3BvbnNlX3dpdGhfdGltZW91dChzZWxmLnRpbWVvdXQpCgogICAgZGVmIGdldF9yZXNwb25zZV93aXRoX3RpbWVvdXQoc2VsZiwgdGltZW91dCk6CiAgICAgICAgaWYgdGltZW91dCA+PSAwIG9yIHRpbWVvdXQgaXMgTm9uZToKICAgICAgICAgICAgc2VsZi50aHJlYWQuam9pbih0aW1lb3V0KQogICAgICAgIHJldHVybiBzZWxmLl9nZXRfcmVzcG9uc2VfZnJvbV90aHJlYWQodGltZW91dCkKCiAgICBkZWYgX2dldF9yZXNwb25zZV9mcm9tX3RocmVhZChzZWxmLCB0aW1lb3V0KToKICAgICAgICBpZiAoKHRpbWVvdXQgaXMgbm90IE5vbmUgYW5kIHRpbWVvdXQgPCAwKSBvcgogICAgICAgICAgICAgICAgc2VsZi50aHJlYWQuaXNBbGl2ZSgpKToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX3N0b3JlX2FuZF9yZXR1cm5fcmVzcG9uc2UoKQogICAgICAgIHNlbGYucnVubmVyaGFuZGxlci5yZW1vdmVfcmVzcG9uc2Uoc2VsZi5yZXNwb25zZV9pZCkKICAgICAgICByZXR1cm4gc2VsZi5fc2VyaWFsaXplKCpzZWxmLnJlc3BvbnNlKQoKICAgIGRlZiBfc3RvcmVfYW5kX3JldHVybl9yZXNwb25zZShzZWxmKToKICAgICAgICBzZWxmLnJ1bm5lcmhhbmRsZXIuYWRkX3Jlc3BvbnNlKHNlbGYucmVzcG9uc2VfaWQsIHNlbGYpCiAgICAgICAgcmV0dXJuIHNlbGYuX3NlcmlhbGl6ZSgndGltZW91dCcsIHNlbGYucmVzcG9uc2VfaWQpCgogICAgZGVmIF9zZXJpYWxpemUoc2VsZiwgc3RlZXJpbmdzdHJpbmcsIG9iaik6CiAgICAgICAgcmV0dXJuIGJhc2U2NC5iNjRlbmNvZGUoc2VsZi5ydW5uZXJoYW5kbGVyLnBpY2tsZXIuZHVtcHMoCiAgICAgICAgICAgIChzdGVlcmluZ3N0cmluZywgc2VsZi5ydW5uZXJoYW5kbGVyLnBpY2tsZXIuZHVtcHMob2JqKSkpKQoKCmRlZiByZXNwb25zZXRocmVhZChmdW5jdGlvbiwgKmFyZ3MsICoqa3dhcmdzKToKICAgICMgcHlsaW50OiBkaXNhYmxlPXVudXNlZC1hcmd1bWVudAogICAgQHdyYXBzKGZ1bmN0aW9uKQogICAgZGVmIGlubmVyX2Z1bmN0aW9uKHJ1bm5lcmhhbmRsZXIsICphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgcmV0dXJuIF9SZXNwb25zZSgKICAgICAgICAgICAgZnVuY3Rpb24sIHJ1bm5lcmhhbmRsZXIsICphcmdzLCAqKmt3YXJncykucnVuX2luX3RocmVhZCgpCgogICAgcmV0dXJuIGlubmVyX2Z1bmN0aW9uCgoKY2xhc3MgX1J1bm5lckhhbmRsZXIob2JqZWN0KToKCiAgICBkZWYgX19pbml0X18oc2VsZik6CiAgICAgICAgc2VsZi5jb250ZXh0bWdyID0gTm9uZQogICAgICAgIHNlbGYucGlja2xlciA9IE5vbmUKICAgICAgICBzZWxmLl9oYW5kbGVkX3R5cGVzID0gTm9uZQogICAgICAgIHNlbGYuX3Jlc3BvbnNlcyA9IGRpY3QoKQoKICAgIGRlZiBpbml0aWFsaXplKHNlbGYsCiAgICAgICAgICAgICAgICAgICBjb250ZXh0bWdyPU5vbmUsCiAgICAgICAgICAgICAgICAgICBwaWNrbGVyPXBpY2tsZSwKICAgICAgICAgICAgICAgICAgIGhhbmRsZWRfdHlwZXM9Tm9uZSk6CiAgICAgICAgc2VsZi5jb250ZXh0bWdyID0gY29udGV4dG1nciBvciBzZWxmLnBpY2tsZV9lcnJvcnMKICAgICAgICBzZWxmLnBpY2tsZXIgPSBwaWNrbGVyCiAgICAgICAgc2VsZi5faGFuZGxlZF90eXBlcyA9IFtdIGlmIGhhbmRsZWRfdHlwZXMgaXMgTm9uZSBlbHNlIGhhbmRsZWRfdHlwZXMKCiAgICBkZWYgYWRkX3Jlc3BvbnNlKHNlbGYsIHJlc3BvbnNlX2lkLCByZXNwb25zZSk6CiAgICAgICAgc2VsZi5fcmVzcG9uc2VzW3Jlc3BvbnNlX2lkXSA9IHJlc3BvbnNlCgogICAgZGVmIF9nZXRfcmVzcG9uc2Uoc2VsZiwgcmVzcG9uc2VfaWQpOgogICAgICAgIHJldHVybiBzZWxmLl9yZXNwb25zZXNbcmVzcG9uc2VfaWRdCgogICAgZGVmIHJlbW92ZV9yZXNwb25zZShzZWxmLCByZXNwb25zZV9pZCk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBkZWwgc2VsZi5fcmVzcG9uc2VzW3Jlc3BvbnNlX2lkXQogICAgICAgIGV4Y2VwdCBLZXlFcnJvcjoKICAgICAgICAgICAgcGFzcwoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBfZGVzZXJpYWxpemUoY29udGVudCwgdW5waWNrbGVyPXBpY2tsZS5VbnBpY2tsZXIpOgogICAgICAgIGlmIChzeXMudmVyc2lvbl9pbmZvWzBdID09IDMpOgogICAgICAgICAgICBjb250ZW50ID0gY29udGVudC5kZWNvZGUoJ3V0Zi04JykKICAgICAgICBvdXRwdXRzdHJlYW0gPSBCeXRlc0lPKGJhc2U2NC5iNjRkZWNvZGUoY29udGVudCkpCiAgICAgICAgcmV0dXJuIHVucGlja2xlcihvdXRwdXRzdHJlYW0pLmxvYWQoKQoKICAgIEBzdGF0aWNtZXRob2QKICAgIGRlZiBfZXh0cmFjdF90YigpOgogICAgICAgIHJldHVybiB0cmFjZWJhY2suZm9ybWF0X2xpc3QodHJhY2ViYWNrLmV4dHJhY3RfdGIoCiAgICAgICAgICAgIHN5cy5leGNfaW5mbygpWzJdKVszOl0pCgogICAgQGNvbnRleHRtYW5hZ2VyCiAgICBkZWYgcGlja2xlX2Vycm9ycyhzZWxmLCByZXNwb25zZSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB5aWVsZCBOb25lCgogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZTogICMgcHlsaW50OiBkaXNhYmxlPWJyb2FkLWV4Y2VwdAogICAgICAgICAgICBlLnRyYWNlID0gc2VsZi5fZXh0cmFjdF90YigpCiAgICAgICAgICAgIHJlc3BvbnNlLnNldF9yZXNwb25zZSgoJ2V4Y2VwdGlvbicsIGUpKQoKICAgIEByZXNwb25zZXRocmVhZAogICAgZGVmIHJ1bihzZWxmLCBjb2RlLCBsb2NhbHNfKToKICAgICAgICByZXR1cm4gKCdydW4nLCBzZWxmLl9nZXRfb2JqZWN0KGNvZGUsIGxvY2Fsc18pKQoKICAgIEByZXNwb25zZXRocmVhZAogICAgZGVmIGFzc2lnbl9hbmRfcnVuKHNlbGYsIGhhbmRsZSwgY29kZSwgbG9jYWxzXyk6CiAgICAgICAgc2VsZi5fZ2V0X29iamVjdCgne2hhbmRsZX0gPSB7Y29kZX0nLmZvcm1hdCgKICAgICAgICAgICAgaGFuZGxlPWhhbmRsZSwgY29kZT1jb2RlKSwgbG9jYWxzXykKICAgICAgICByZXR1cm4gc2VsZi5fZ2V0X2hhbmRsZWQoaGFuZGxlLCBsb2NhbHNfKQoKICAgIEByZXNwb25zZXRocmVhZAogICAgZGVmIHJ1bl9hbmRfcmV0dXJuX2hhbmRsZWQoc2VsZiwgY29kZSwgbG9jYWxzXyk6CiAgICAgICAgcmV0dXJuIHNlbGYuX2dldF9oYW5kbGVkKGNvZGUsIGxvY2Fsc18pCgogICAgZGVmIGdldF9yZXNwb25zZShzZWxmLCByZXNwb25zZV9pZCwgdGltZW91dCk6CiAgICAgICAgcmV0dXJuIHNlbGYuX2dldF9yZXNwb25zZSgKICAgICAgICAgICAgcmVzcG9uc2VfaWQpLmdldF9yZXNwb25zZV93aXRoX3RpbWVvdXQodGltZW91dCkKCiAgICBkZWYgX2dldF9oYW5kbGVkKHNlbGYsIGNvZGUsIGxvY2Fsc18pOgogICAgICAgIG9iaiA9IHNlbGYuX2dldF9vYmplY3QoY29kZSwgbG9jYWxzXykKICAgICAgICBpc19oYW5kbGVkID0gc2VsZi5faXNfaW5faGFuZGxlZF90eXBlcyhvYmopCiAgICAgICAgc3RlZXJpbmdzdHJpbmcgPSAnaGFuZGxlZCcgaWYgaXNfaGFuZGxlZCBlbHNlICdub3RoYW5kbGVkJwogICAgICAgIHJldHVybiAoc3RlZXJpbmdzdHJpbmcsIG9iaiBpZiBpc19oYW5kbGVkIGVsc2UgTm9uZSkKCiAgICBkZWYgX2lzX2luX2hhbmRsZWRfdHlwZXMoc2VsZiwgb2JqKToKICAgICAgICBmb3IgdCBpbiBzZWxmLl9oYW5kbGVkX3R5cGVzOgogICAgICAgICAgICBpZiB0IGlzIE5vbmU6CiAgICAgICAgICAgICAgICBpZiBvYmogaXMgTm9uZToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2Uob2JqLCB0KToKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIF9nZXRfb2JqZWN0KGNvZGUsIGxvY2Fsc18pOgogICAgICAgIHRyeToKICAgICAgICAgICAgY29kZV9vYmogPSBjb21waWxlKGNvZGUsICcnLCAnZXZhbCcpCiAgICAgICAgZXhjZXB0IFN5bnRheEVycm9yOgogICAgICAgICAgICBjb2RlX29iaiA9IGNvbXBpbGUoY29kZSwgJycsICdzaW5nbGUnKQogICAgICAgIHJldHVybiBldmFsKGNvZGVfb2JqLCBsb2NhbHNfKQoKCl9SVU5ORVJIQU5ETEVSID0gX1J1bm5lckhhbmRsZXIoKQpxAC4=')), 'RunnerHandler', 'exec'), timeout=-1
PythonShellEmulator response: 
MainProcess 2019-06-11 14:17:03,066.066 DEBUG PythonShellEmulator response: 
PythonShellEmulator running cmd: runnerhandlerns = {}, timeout=-1
MainProcess 2019-06-11 14:17:03,066.066 DEBUG PythonShellEmulator running cmd: runnerhandlerns = {}, timeout=-1
PythonShellEmulator response: 
MainProcess 2019-06-11 14:17:03,066.066 DEBUG PythonShellEmulator response: 
PythonShellEmulator running cmd: exec(_handlercode, runnerhandlerns), timeout=-1
MainProcess 2019-06-11 14:17:03,066.066 DEBUG PythonShellEmulator running cmd: exec(_handlercode, runnerhandlerns), timeout=-1
PythonShellEmulator response: 
MainProcess 2019-06-11 14:17:03,066.066 DEBUG PythonShellEmulator response: 
PythonShellEmulator running cmd: runnerhandlerns['_RUNNERHANDLER'].initialize(contextmgr=runnerhandlerns['_RUNNERHANDLER'].pickle_errors, pickler=pickle, handled_types=runnerhandlerns['_RUNNERHANDLER']._deserialize(b'gANdcQAoTmNidWlsdGlucwpzdHIKcQGFcQJjYnVpbHRpbnMKaW50CnEDY2J1aWx0aW5zCmZsb2F0CnEEZS4=', pickle.Unpickler)), timeout=-1
MainProcess 2019-06-11 14:17:03,067.067 DEBUG PythonShellEmulator running cmd: runnerhandlerns['_RUNNERHANDLER'].initialize(contextmgr=runnerhandlerns['_RUNNERHANDLER'].pickle_errors, pickler=pickle, handled_types=runnerhandlerns['_RUNNERHANDLER']._deserialize(b'gANdcQAoTmNidWlsdGlucwpzdHIKcQGFcQJjYnVpbHRpbnMKaW50CnEDY2J1aWx0aW5zCmZsb2F0CnEEZS4=', pickle.Unpickler)), timeout=-1
PythonShellEmulator response: 
MainProcess 2019-06-11 14:17:03,067.067 DEBUG PythonShellEmulator response: 
PythonShellEmulator running cmd: import collections, timeout=-1
MainProcess 2019-06-11 14:17:03,067.067 DEBUG PythonShellEmulator running cmd: import collections, timeout=-1
PythonShellEmulator response: 
MainProcess 2019-06-11 14:17:03,067.067 DEBUG PythonShellEmulator response: 
MainProcess 2019-06-11 14:17:03,068.068 DEBUG preparing call - collections.namedtuple(*('A', ['a']), **{})
PythonShellEmulator running cmd: runnerhandlerns['_RUNNERHANDLER'].assign_and_run("runnerhandlerns['_PROXY_CONTAINER.handle_ffcdaeededf147048a1c180d6167235f']", "collections.namedtuple(runnerhandlerns['_RUNNERHANDLER']._deserialize(b'gANYAQAAAEFxAC4=', pickle.Unpickler), runnerhandlerns['_RUNNERHANDLER']._deserialize(b'gANdcQBYAQAAAGFxAWEu', pickle.Unpickler))", timeout=3600.0, locals_=locals()), timeout=3630.0
MainProcess 2019-06-11 14:17:03,068.068 DEBUG PythonShellEmulator running cmd: runnerhandlerns['_RUNNERHANDLER'].assign_and_run("runnerhandlerns['_PROXY_CONTAINER.handle_ffcdaeededf147048a1c180d6167235f']", "collections.namedtuple(runnerhandlerns['_RUNNERHANDLER']._deserialize(b'gANYAQAAAEFxAC4=', pickle.Unpickler), runnerhandlerns['_RUNNERHANDLER']._deserialize(b'gANdcQBYAQAAAGFxAWEu', pickle.Unpickler))", timeout=3600.0, locals_=locals()), timeout=3630.0
PythonShellEmulator response: b'gANYCgAAAG5vdGhhbmRsZWRxAEMEgANOLnEBhnECLg=='
MainProcess 2019-06-11 14:17:03,069.069 DEBUG PythonShellEmulator response: b'gANYCgAAAG5vdGhhbmRsZWRxAEMEgANOLnEBhnECLg=='
MainProcess 2019-06-11 14:17:03,069.069 DEBUG TypeError: a bytes-like object is required, not 'str'
Backtrace: 
  File "/home/spaukkon/crl-interactivesessions/.tox/py37/lib/python3.7/site-packages/crl/interactivesessions/runnerterminal.py", line 219, in run
    return self._run_in_session(cmd, timeout)
  File "/home/spaukkon/crl-interactivesessions/.tox/py37/lib/python3.7/site-packages/crl/interactivesessions/runnerterminal.py", line 229, in _run_in_session
    return self._run_full_output(cmd, timeout=timeout).rstrip('\r\n')

